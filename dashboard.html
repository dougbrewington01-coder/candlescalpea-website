<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CandleScalpEA Dashboard</title>
  <meta name="description" content="Customer Dashboard — CandleScalpEA 5.0 (MT5)" />

  <style>
    :root{
      --bg:#0b0f19;
      --panel:rgba(255,255,255,0.06);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.70);
      --line:rgba(255,255,255,0.10);
      --radius:18px;
      --radius2:14px;
      --accent:#7c3aed;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:var(--bg);
    }
    .container{max-width:1100px;margin:auto;padding:20px}
    h1{margin:0 0 10px}
    .grid{display:grid;gap:14px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-2{grid-template-columns:1fr 1fr}
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:16px
    }
    .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--line)}
    .row:last-child{border-bottom:none}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px
    }
    .ok{background:rgba(34,197,94,.15);color:#b9ffd4}
    .warn{background:rgba(245,158,11,.15);color:#ffe1a6}
    .bad{background:rgba(239,68,68,.15);color:#ffc6c6}
    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:white;
      cursor:pointer;
      font-weight:700
    }
    .btn-primary{background:rgba(124,58,237,.35)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#000;
      color:white
    }
    footer{margin-top:30px;font-size:12px;color:var(--muted)}
    @media(max-width:900px){
      .grid-3,.grid-2{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Customer Dashboard</h1>

  <div class="grid grid-3">
    <div class="card">
      <h3>Account</h3>
      <div class="row"><span>Email</span><span id="email">—</span></div>
      <div class="row"><span>Email Verified</span><span id="emailStatus" class="pill warn">—</span></div>
    </div>

    <div class="card">
      <h3>Subscription</h3>
      <div class="row"><span>Status</span><span id="subStatus" class="pill warn">—</span></div>
      <div class="row"><span>Plan</span><span>$50 / month</span></div>
    </div>

    <div class="card">
      <h3>EA</h3>
      <div class="row"><span>Product</span><span>CandleScalpEA 5.0</span></div>
      <div class="row"><span>Version</span><span>v1.31</span></div>
      <div class="row"><span>Status</span><span id="eaStatus" class="pill warn">—</span></div>
    </div>
  </div>

  <div class="grid grid-2" style="margin-top:14px">
    <div class="card">
      <h3>MT5 Account</h3>

      <input id="mt5" placeholder="MT5 Account Number" />
      <input id="nickname" placeholder="Nickname (case-sensitive)" style="margin-top:8px" />

      <div style="margin-top:10px">
        <button class="btn btn-primary" id="saveBtn">Save</button>
        <span id="saveMsg" style="margin-left:10px"></span>
      </div>
    </div>

    <div class="card">
      <h3>Download</h3>
      <p id="downloadMsg">Locked</p>
      <a id="downloadBtn" class="btn btn-primary" href="#" disabled>Download EA</a>
    </div>
  </div>

  <footer>
    CandleScalpEA 5.0 — Doug Brewington
  </footer>

</div>

<script>
const API = "/api";

async function loadDashboard(){
  const res = await fetch(API + "/me", {credentials:"include"});
  if(!res.ok){ location.href="/login.html"; return; }
  const d = await res.json();

  document.getElementById("email").textContent = d.email;
  setPill("emailStatus", d.email_verified);
  setPill("subStatus", d.subscription_active);
  setPill("eaStatus", d.license_active);

  if(d.email_verified && d.subscription_active){
    document.getElementById("downloadBtn").removeAttribute("disabled");
    document.getElementById("downloadBtn").href = API + "/download";
    document.getElementById("downloadMsg").textContent = "Ready";
  }
}

function setPill(id, ok){
  const el = document.getElementById(id);
  el.textContent = ok ? "Active" : "Inactive";
  el.className = "pill " + (ok ? "ok" : "warn");
}

document.getElementById("saveBtn").onclick = async ()=>{
  const mt5 = mt5.value.trim();
  const nickname = nickname.value.trim();
  if(!mt5 || !nickname) return;

  const r = await fetch(API + "/mt5/bind",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    credentials:"include",
    body:JSON.stringify({mt5,nickname})
  });

  document.getElementById("saveMsg").textContent =
    r.ok ? "Saved" : "Error";
};

loadDashboard();
</script>
</body>
</html>
