// ==============================
// server.js (FULL FILE - FINAL)
// PayPal Webhooks + License Check + Customer Session
// ES Modules version
// ==============================

import express from "express";
import crypto from "crypto";
import fs from "fs";
import path from "path";
import fetch from "node-fetch";
import session from "express-session";

// ------------------------------
// APP SETUP
// ------------------------------
const app = express();

app.use(express.json({ limit: "1mb" }));

// ------------------------------
// SESSION
// ------------------------------
app.use(
  session({
    name: "cseasession",
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true,
      httpOnly: true,
      sameSite: "lax",
      maxAge: 1000 * 60 * 60 * 24 * 7,
    },
  })
);

// ------------------------------
// ENV / CONFIG
// ------------------------------
const PORT = process.env.PORT || 3000;

const PAYPAL_CLIENT_ID = process.env.PAYPAL_CLIENT_ID || "";
const PAYPAL_SECRET = process.env.PAYPAL_SECRET || "";
const PAYPAL_WEBHOOK_ID = process.env.PAYPAL_WEBHOOK_ID || "";

const CSEA_API_KEY = process.env.CSEA_API_KEY || "";

const PAYPAL_BASE =
  process.env.PAYPAL_ENV === "sandbox"
    ? "https://api-m.sandbox.paypal.com"
    : "https://api-m.paypal.com";

// ------------------------------
// SIMPLE JSON "DB"
// ------------------------------
const DATA_DIR = path.join(process.cwd(), "data");
const USERS_FILE = path.join(DATA_DIR, "users.json");

function ensureDataStore() {
  if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });
  if (!fs.existsSync(USERS_FILE)) fs.writeFileSync(USERS_FILE, "[]", "utf8");
}

function readUsers() {
  ensureDataStore();
  try {
    return JSON.parse(fs.readFileSync(USERS_FILE, "utf8") || "[]");
  } catch {
    return [];
  }
}

function writeUsers(users) {
  ensureDataStore();
  fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2), "utf8");
}

function nowISO() {
  return new Date().toISOString();
}

// ------------------------------
// HELPERS
// ------------------------------
function normStr(v) {
  return typeof v === "string" ? v.trim() : "";
}

function isDigits(v) {
  return /^[0-9]+$/.test(v);
}

function sendOk(res) {
  return res.status(200).json({ ok: true });
}

function sendNo(res, reason = "not_allowed") {
  return res.status(200).json({ ok: false, reason });
}

function checkApiKey(req) {
  if (!CSEA_API_KEY) return true;
  const got = (req.headers["x-csea-key"] || "").toString().trim();
  if (!got || got.length !== CSEA_API_KEY.length) return false;
  return crypto.timingSafeEqual(Buffer.from(got), Buffer.from(CSEA_API_KEY));
}

// ------------------------------
// PAYPAL HELPERS
// ------------------------------
async function paypalGetAccessToken() {
  const basic = Buffer.from(`${PAYPAL_CLIENT_ID}:${PAYPAL_SECRET}`).toString("base64");

  const resp = await fetch(`${PAYPAL_BASE}/v1/oauth2/token`, {
    method: "POST",
    headers: {
      Authorization: `Basic ${basic}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "grant_type=client_credentials",
  });

  const data = await resp.json();
  return data.access_token;
}

// ------------------------------
// USER LOOKUPS
// ------------------------------
function getUserByNickname(users, nickname) {
  return users.find((u) => u.nickname === nickname) || null;
}

function getUserBySubscriptionId(users, subId) {
  return users.find((u) => u.paypal_subscription_id === subId) || null;
}

// ------------------------------
// LICENSE LOGIC
// ------------------------------
function evaluateLicense(user, mt5Account) {
  if (!user) return { ok: false };
  if (!user.email_verified) return { ok: false };
  if (user.subscription_status !== "active") return { ok: false };
  if (user.mt5_account && user.mt5_account !== mt5Account) return { ok: false };
  return { ok: true };
}

// ------------------------------
// LICENSE ROUTES (EA)
// ------------------------------
async function licenseCheckHandler(req, res) {
  try {
    if (!checkApiKey(req)) return sendNo(res);

    const nickname = normStr(req.body.nickname || req.query.nickname);
    const mt5 = normStr(req.body.mt5 || req.query.mt5);

    const users = readUsers();
    const user = getUserByNickname(users, nickname);

    const result = evaluateLicense(user, mt5);
    if (!result.ok) return sendNo(res);

    if (!user.mt5_account) {
      user.mt5_account = mt5;
      user.updated_at = nowISO();
      writeUsers(users);
    }

    sendOk(res);
  } catch {
    sendNo(res);
  }
}

app.post("/api/license", licenseCheckHandler);
app.post("/license", licenseCheckHandler);
app.get("/api/license", licenseCheckHandler);
app.get("/license", licenseCheckHandler);

// ------------------------------
// CUSTOMER SESSION ENDPOINTS
// ------------------------------
app.get("/api/me", (req, res) => {
  const email = req.session?.email;
  if (!email) return res.status(401).json({ ok: false });

  const users = readUsers();
  const user = users.find((u) => u.email === email);
  if (!user) return res.status(401).json({ ok: false });

  res.json({
    email: user.email,
    email_verified: !!user.email_verified,
    subscription_active: user.subscription_status === "active",
    license_active: user.subscription_status === "active",
    mt5_account: user.mt5_account || "",
    nickname: user.nickname || "",
  });
});

app.post("/api/mt5/bind", (req, res) => {
  const email = req.session?.email;
  if (!email) return res.status(401).json({ ok: false });

  const { mt5, nickname } = req.body;
  if (!mt5 || !nickname) return res.status(400).json({ ok: false });

  const users = readUsers();
  const user = users.find((u) => u.email === email);
  if (!user) return res.status(400).json({ ok: false });

  user.mt5_account = mt5;
  user.nickname = nickname;
  user.updated_at = nowISO();
  writeUsers(users);

  res.json({ ok: true });
});

// ------------------------------
// HEALTH
// ------------------------------
app.get("/", (req, res) => res.send("CandleScalpEA API is running"));
app.get("/health", (req, res) => res.json({ ok: true }));

// ------------------------------
// LISTEN
// ------------------------------
app.listen(PORT, "0.0.0.0", () => {
  console.log(`Server listening on port ${PORT}`);
});
